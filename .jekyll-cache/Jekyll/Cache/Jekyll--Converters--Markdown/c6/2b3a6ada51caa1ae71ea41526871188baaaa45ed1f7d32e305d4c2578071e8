I"¼E<p><br /><br /></p>

<h1 id="í˜ì´ì§€-ì²˜ë¦¬ë˜ëŠ”-ì˜í™”ë³„-í‰ê· -ì ìˆ˜ë¦¬ë·°-ê°œìˆ˜-êµ¬í•˜ê¸°"><center>í˜ì´ì§€ ì²˜ë¦¬ë˜ëŠ” ì˜í™”ë³„ í‰ê·  ì ìˆ˜/ë¦¬ë·° ê°œìˆ˜ êµ¬í•˜ê¸°</center></h1>

<p><br /><br /></p>

<p><strong>MovieRepository ì¸í„°í˜ì´ìŠ¤</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MovieRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Movie</span><span class="o">,</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
   <span class="nd">@Query</span><span class="o">(</span><span class="s">"select m, max(mi), avg(coalesce(r.grade,0)), count(distinct r) from Movie m "</span><span class="o">+</span><span class="s">"left outer join MovieImage mi on mi.movie=m "</span><span class="o">+</span>
            <span class="s">"left outer join Review r on r.movie=m group by m"</span><span class="o">)</span>
    <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">[]&gt;</span> <span class="nf">getListPage</span><span class="o">(</span><span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p><br /></p>

<ul>
  <li>coalece(a1, a2, a3â€¦): a1ë¶€í„° aNê¹Œì§€ ì²˜ìŒìœ¼ë¡œ nullì´ ì•„ë‹Œ ê°’ì„ ë¦¬í„´í•œë‹¤</li>
  <li>ì²˜ìŒ select mì€ Movie ì—”í‹°í‹°ì˜ ëª¨ë“  ì—”í‹°í‹°ë¥¼ ì„ íƒí•˜ê²Œ ë¨, mië„ ë§ˆì°¬ê°€ì§€</li>
  <li>JPQLì—ì„œ group byë¥¼ ì ìš©í•˜ë©´ ë¦¬ë·°ì˜ ê°œìˆ˜ì™€ ë¦¬ë·°ì˜ í‰ê·  í‰ì ì„ êµ¬í•  ìˆ˜ ìˆìŒ</li>
</ul>

<p><br /><br />
MovieRepositoryTests í´ë˜ìŠ¤ì— í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆëŠ” ë©”ì„œë“œë¥¼ ì‘ì„±í•œë‹¤.</p>

<p><strong>MovieRepositoryTests í´ë˜ìŠ¤</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testListPage</span><span class="o">(){</span>
        <span class="nc">PageRequest</span> <span class="n">pageRequest</span><span class="o">=</span> <span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">10</span><span class="o">,</span><span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">DESC</span><span class="o">,</span><span class="s">"mno"</span><span class="o">));</span>
        <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">[]&gt;</span> <span class="n">result</span><span class="o">=</span><span class="n">movieRepository</span><span class="o">.</span><span class="na">getListPage</span><span class="o">(</span><span class="n">pageRequest</span><span class="o">);</span>

        <span class="k">for</span><span class="o">(</span><span class="nc">Object</span><span class="o">[]</span> <span class="n">objects</span> <span class="o">:</span> <span class="n">result</span><span class="o">.</span><span class="na">getContent</span><span class="o">()){</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">objects</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><u>ì´ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê²Œ ë˜ë©´ ì˜ˆìƒê³¼ ë‹¬ë¦¬ ê° ì˜í™”ë§ˆë‹¤ ì´ë¯¸ì§€ë¥¼ ì°¾ëŠ” ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ë©´ì„œ ë¹„íš¨ìœ¨ì ìœ¼ë¡œ ì—¬ëŸ¬ ë²ˆ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.</u></p>

<p><strong>ì¦‰ N+1 ë¬¸ì œ ë°œìƒ</strong></p>

<ul>
  <li>max()ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ joinìœ¼ë¡œ ê²°í•©ë  ë‹¹ì‹œì˜ ë°ì´í„° 1ê°œë§Œ ê°€ì ¸ì˜¤ê²Œ ë˜ê³  max()ë¥¼ ì‚¬ìš©í•˜ë©´ joinìœ¼ë¡œ ê²°í•©ë  ë‹¹ì‹œì˜ ë°ì´í„° ë§ê³  ë²ˆí˜¸ê°€ ê°€ì¥ í° ì´ë¯¸ì§€ íŒŒì¼(ì—¬ê¸°ì„œ inum)ì— ëŒ€í•œ ì •ë³´ë¥¼ ê°€ì ¸ì™€ì•¼í•˜ë¯€ë¡œ MovieImageì— ëŒ€í•œ selectë¬¸ì„ 1íšŒì”© ì´ 10íšŒ ì‹¤í–‰ë¨</li>
</ul>

<p>JPQLì€ ë³„ë„ì˜ ì²˜ë¦¬ ì—†ì´ ìœ„ì˜ êµ¬ì¡°ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆë‹¤.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Query</span><span class="o">(</span><span class="s">"select m, mi, avg(coalesce(r.grade,0)), count(distinct r) from Movie m "</span><span class="o">+</span><span class="s">"left outer join MovieImage mi on mi.movie=m "</span><span class="o">+</span>
            <span class="s">"left outer join Review r on r.movie=m group by m"</span><span class="o">)</span>
    <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">[]&gt;</span> <span class="nf">getListPage</span><span class="o">(</span><span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
</code></pre></div></div>

<ul>
  <li>max() ë¶€ë¶„ ì œê±°</li>
</ul>

<h3 id="íŠ¹ì •-ì˜í™”ì˜-ëª¨ë“ -ì´ë¯¸ì§€ì™€-í‰ê· -í‰ì ë¦¬ë·°-ê°œìˆ˜">íŠ¹ì • ì˜í™”ì˜ ëª¨ë“  ì´ë¯¸ì§€ì™€ í‰ê·  í‰ì /ë¦¬ë·° ê°œìˆ˜</h3>

<ul>
  <li>ì˜í™”ë¥¼ ì¡°íšŒí•  ë•ŒëŠ” ì˜í™”(Movie)ë¿ ì•„ë‹ˆë¼ í•´ë‹¹ ì˜í™”ì˜ í‰ê·  í‰ì /ë¦¬ë·° ê°œìˆ˜ë¥¼ í™”ë©´ì—ì„œ ì‚¬ìš©í•  ì¼ì´ ìˆìœ¼ë¯€ë¡œ MovieRepositoryì— í•´ë‹¹ ê¸°ëŠ¥ì„ ì¶”ê°€</li>
</ul>

<p><strong>MovieRepository ì¸í„°í˜ì´ìŠ¤</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">org.zerock.mreview.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.domain.Page</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.domain.Pageable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.Query</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.zerock.mreview.entity.Movie</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.zerock.mreview.entity.MovieImage</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MovieRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Movie</span><span class="o">,</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Query</span><span class="o">(</span><span class="s">"select m, mi, avg(coalesce(r.grade,0)), count(distinct r) from Movie m "</span><span class="o">+</span><span class="s">"left outer join MovieImage mi on mi.movie=m "</span><span class="o">+</span>
            <span class="s">"left outer join Review r on r.movie=m group by m"</span><span class="o">)</span>
    <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">[]&gt;</span> <span class="nf">getListPage</span><span class="o">(</span><span class="nc">Pageable</span> <span class="n">pageable</span><span class="o">);</span>

    <span class="nd">@Query</span><span class="o">(</span><span class="s">"select m, mi "</span><span class="o">+</span><span class="s">"from Movie m left outer join MovieImage mi on mi.movie=m "</span><span class="o">+</span><span class="s">"where m.mno=:mno"</span><span class="o">)</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">[]&gt;</span> <span class="nf">getMovieWithAll</span><span class="o">(</span><span class="nc">Long</span> <span class="n">mno</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>getMovieWillAllì˜ @Query ë¶€ë¶„ì—ì„œ m.mno=:mno ì˜ =:ëŠ” getMovieWithAll(Long mno)ì—ì„œ ë§¤ê°œë³€ìˆ˜ì¸ mnoë¥¼ ì˜ë¯¸í•  ìˆ˜ ìˆê²Œ í•¨
    <ul>
      <li>ì¦‰ =:mnoëŠ” Long mnoì˜ mnoì„</li>
    </ul>
  </li>
</ul>

<p><strong>í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„± MovieRepositoryTests</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testGetMovieWithAll</span><span class="o">(){</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">[]&gt;</span> <span class="n">result</span><span class="o">=</span><span class="n">movieRepository</span><span class="o">.</span><span class="na">getMovieWithAll</span><span class="o">(</span><span class="mi">94L</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="nc">Object</span><span class="o">[]</span> <span class="nl">arr:</span><span class="n">result</span><span class="o">){</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">arr</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>ë¦¬ë·°(Review)ì™€ ê´€ë ¨ëœ ë‚´ìš© ì²˜ë¦¬ëŠ” â€˜left joinâ€™ì„ ì´ìš©í•˜ë©´ ëœë‹¤. ë¦¬ë·°ì™€ ì¡°ì¸í•œ í›„ì— count(), avg() ë“±ì˜ í•¨ìˆ˜ë¥¼ ì´ìš©í•˜ê²Œ ë˜ëŠ”ë° ì´ë•Œ ì˜í™” ì´ë¯¸ì§€(MovieImage) ë³„ë¡œ group byë¥¼ ì‹¤í–‰í•´ì•¼ë§Œ í•œë‹¤.</p>

<p><strong>MovieRepositoryì˜ getMovieWithAll() ìˆ˜ì •</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Query</span><span class="o">(</span><span class="s">"select m, mi, avg(coalesce(r.grade,0)), count(r) "</span><span class="o">+</span>
            <span class="s">"from Movie m left outer join MovieImage mi on mi.movie=m "</span> <span class="o">+</span>
            <span class="s">"left outer join Review r on r.movie=m "</span><span class="o">+</span>
            <span class="s">"where m.mno=:mno group by mi"</span><span class="o">)</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">[]&gt;</span> <span class="nf">getMovieWithAll</span><span class="o">(</span><span class="nc">Long</span> <span class="n">mno</span><span class="o">);</span>
</code></pre></div></div>

<ul>
  <li>left outer join ì¶”ê°€ì™€ ë§ˆì§€ë§‰ì˜ group by ë¶€ë¶„ì— ì˜í™” ì´ë¯¸ì§€ë³„ë¡œ ê·¸ë£¹ì„ ë§Œë“¤ì–´ì„œ ì˜í™” ì´ë¯¸ì§€ë“¤ì˜ ê°œìˆ˜ë§Œí¼ ë°ì´í„°ë¥¼ ë§Œë“¤ì–´ ë‚¼ ìˆ˜ ìˆê²Œ ë¨</li>
</ul>

<p><strong>íŠ¹ì • ì˜í™”ì˜ ëª¨ë“  ë¦¬ë·°ì™€ íšŒì›ì˜ ë‹‰ë„¤ì„</strong></p>

<ul>
  <li>ì˜í™” ì¡°íšŒ í™”ë©´ì—ì„œëŠ” ì˜í™” ë¦¬ë·°(Review)ë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆì–´ì•¼í•¨</li>
  <li>ìì‹ ì´ ì˜í™”ì— ëŒ€í•œ ë¦¬ë·°ë¥¼ ë“±ë¡í•˜ê±°ë‚˜ ìˆ˜ì •/ì‚­ì œí•  ìˆ˜ ìˆì–´ì•¼í•¨</li>
</ul>

<p>íŠ¹ì • ì˜í™”ì— ëŒ€í•œ ì˜í™” ë¦¬ë·°ëŠ” ReviewRepositoryì— ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•œë‹¤.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">org.zerock.mreview.repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.EntityGraph</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.Modifying</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.Query</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.zerock.mreview.entity.Member</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.zerock.mreview.entity.Movie</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.zerock.mreview.entity.Review</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ReviewRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Review</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Review</span><span class="o">&gt;</span> <span class="nf">findByMovie</span><span class="o">(</span><span class="nc">Movie</span> <span class="n">movie</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ì´ì œ findByMovie()ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•´ì„œ Reviewì—ì„œ í•„ìš”í•œ ë°ì´í„°ë¥¼ ì¶”ì¶œí•œë‹¤.
test repository ì•ˆì— ReviewRepositoryTestsì— ì½”ë“œë¥¼ ì‘ì„±í•œë‹¤.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testGetMovieReviews</span><span class="o">(){</span>
        <span class="nc">Movie</span> <span class="n">movie</span><span class="o">=</span><span class="nc">Movie</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">mno</span><span class="o">(</span><span class="mi">92L</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>

        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Review</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="n">reviewRepository</span><span class="o">.</span><span class="na">findByMovie</span><span class="o">(</span><span class="n">movie</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">movieReview</span><span class="o">-&gt;{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">movieReview</span><span class="o">.</span><span class="na">getReviewnum</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"\t"</span><span class="o">+</span><span class="n">movieReview</span><span class="o">.</span><span class="na">getGrade</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"\t"</span><span class="o">+</span><span class="n">movieReview</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"\t"</span><span class="o">+</span><span class="n">movieReview</span><span class="o">.</span><span class="na">getMember</span><span class="o">().</span><span class="na">getEmail</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"---------------------------"</span><span class="o">);</span>
        <span class="o">});</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>ì´ë•Œ findByMovieëŠ” ì¿¼ë¦¬ ë©”ì„œë“œì´ë‹¤.
Spring Data JPAì˜ ê²½ìš° ì—¬ëŸ¬ ì²˜ë¦¬ë¥¼ ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ ë°©ë²•ì„ ì œê³µí•œë‹¤.</p>

<ul>
  <li>ì¿¼ë¦¬ ë©”ì„œë“œ: ë©”ì„œë“œì˜ ì´ë¦„ ìì²´ê°€ ì¿¼ë¦¬ì˜ êµ¬ë¬¸ìœ¼ë¡œ ì²˜ë¦¬ë˜ëŠ” ê¸°ëŠ¥</li>
  <li>@Query: SQLê³¼ ìœ ì‚¬í•˜ê²Œ ì—”í‹°í‹° í´ë˜ìŠ¤ì˜ ì •ë³´ë¥¼ ì´ìš©í•´ì„œ ì¿¼ë¦¬ë¥¼ ì‘ì„±í•˜ëŠ” ê¸°ëŠ¥</li>
  <li>Querydsl ë“±ì˜ ë™ì  ì¿¼ë¦¬ ì²˜ë¦¬ ê¸°ëŠ¥</li>
</ul>

<p>ì¿¼ë¦¬ ë©”ì„œë“œëŠ” ë§ ê·¸ëŒ€ë¡œ ë©”ì„œë“œì˜ ì´ë¦„ ìì²´ê°€ ì§ˆì˜(query)ë¬¸ì´ ë˜ëŠ” í¥ë¯¸ë¡œìš´ ê¸°ëŠ¥ì´ë‹¤. ì¿¼ë¦¬ ë©”ì„œë“œëŠ” ì£¼ë¡œ â€˜findByë‚˜ getByâ€¦â€˜ë¡œ ì‹œì‘í•˜ê³  ì´í›„ì— í•„ìš”í•œ í•„ë“œ ì¡°ê±´ì´ë‚˜ And, Orì™€ ê°™ì€ í‚¤ì›Œë“œë¥¼ ì´ìš©í•´ì„œ ë©”ì„œë“œì˜ ì´ë¦„ ìì²´ë¡œ ì§ˆì˜ ì¡°ê±´ì„ ë§Œë“¤ì–´ ë‚¸ë‹¤.
ìì„¸í•œ ë‚´ìš©ì€ <strong>Spring Data JPA Reference</strong>ë¥¼ ì´ìš©í•´ì„œ ì°¾ëŠ”ë‹¤.</p>

<p>ë³´ì‹œë‹¤ì‹œí”¼ findById ìª½ì„ ë³´ë©´</p>

<p><img src="../../../../images/Learning_SpringBoot_with_Web_Project/Part4/Chapter7/ref.PNG" alt="ref" />
<br /><br /><br /></p>
:ET